<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jing.admin.mapper.ScheduleJobMapper">
    <!-- 调度任务DTO结果映射 -->
    <resultMap id="ScheduleJobDTOMap" type="com.jing.admin.model.dto.ScheduleJobDTO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="workflow_id" property="workflowId"/>
        <result column="trigger_type" property="triggerType"/>
        <result column="trigger_config" property="triggerConfig"/>
        <result column="status" property="status"/>
        <result column="description" property="description"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="update_user_id" property="updateUserId"/>
        <result column="update_user_name" property="updateUserName"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 分页查询调度任务（关联用户表） -->
    <select id="selectScheduleJobPageWithUser" resultMap="ScheduleJobDTOMap">
        SELECT
        sj.id,
        sj.name,
        sj.workflow_id,
        sj.trigger_type,
        sj.trigger_config,
        sj.status,
        sj.description,
        sj.tenant_id,
        sj.create_user_id,
        cu.username AS create_user_name,
        sj.update_user_id,
        uu.username AS update_user_name,
        sj.create_time,
        sj.update_time
        FROM
        tb_schedule_job sj
        LEFT JOIN
        tb_users cu ON sj.create_user_id = cu.uuid
        LEFT JOIN
        tb_users uu ON sj.update_user_id = uu.uuid
        <where>
            <if test="query.name != null and query.name != ''">
                AND sj.name LIKE CONCAT('%', #{query.name}, '%')
            </if>
            <if test="query.workflowId != null and query.workflowId != ''">
                AND sj.workflow_id = #{query.workflowId}
            </if>
            <if test="query.triggerType != null and query.triggerType != ''">
                AND sj.trigger_type = #{query.triggerType}
            </if>
            <if test="query.status != null and query.status != ''">
                AND sj.status = #{query.status}
            </if>
        </where>
        ORDER BY sj.create_time DESC
    </select>

</mapper>