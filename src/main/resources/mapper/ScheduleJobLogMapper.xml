<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jing.admin.mapper.ScheduleJobLogMapper">
    <!-- 调度任务执行记录DTO结果映射 -->
    <resultMap id="ScheduleJobLogDTOMap" type="com.jing.admin.model.dto.ScheduleJobLogDTO">
        <id column="id" property="id"/>
        <result column="job_id" property="jobId"/>
        <result column="workflow_id" property="workflowId"/>
        <result column="trigger_type" property="triggerType"/>
        <result column="status" property="status"/>
        <result column="result" property="result"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="execution_time" property="executionTime"/>
        <result column="error_message" property="errorMessage"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="update_user_id" property="updateUserId"/>
        <result column="update_user_name" property="updateUserName"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 分页查询调度任务执行记录（关联用户表） -->
    <select id="selectScheduleJobLogPageWithUser" resultMap="ScheduleJobLogDTOMap">
        SELECT
        sjl.id,
        sjl.job_id,
        sjl.workflow_id,
        sjl.trigger_type,
        sjl.status,
        sjl.result,
        sjl.start_time,
        sjl.end_time,
        sjl.execution_time,
        sjl.error_message,
        sjl.tenant_id,
        sjl.create_user_id,
        cu.username AS create_user_name,
        sjl.update_user_id,
        uu.username AS update_user_name,
        sjl.create_time,
        sjl.update_time
        FROM
        tb_schedule_job_log sjl
        LEFT JOIN
        tb_users cu ON sjl.create_user_id = cu.uuid
        LEFT JOIN
        tb_users uu ON sjl.update_user_id = uu.uuid
        <where>
            <if test="query.jobId != null and query.jobId != ''">
                AND sjl.job_id = #{query.jobId}
            </if>
            <if test="query.workflowId != null and query.workflowId != ''">
                AND sjl.workflow_id = #{query.workflowId}
            </if>
            <if test="query.status != null and query.status != ''">
                AND sjl.status = #{query.status}
            </if>
        </where>
        ORDER BY sjl.create_time DESC
    </select>

</mapper>